{"version":3,"file":"formbuilder-conditional-logic.es.js","sources":["../src/plugin/builder.ts","../src/renderer/setup.ts"],"sourcesContent":["// src/plugin/builder.ts\n/**\n * Builder plugin for formBuilder: adds Conditional Logic panel and Groups modal.\n * Exports:\n *  - withConditionalLogic(opts) â†’ formBuilder options extension\n *  - attachLogicGroupsManager(toolbarEl, hooks)\n */\ntype UserAttrs = Record<string, any>;\n\nexport interface FieldMeta {\n    name: string;\n    type: string;\n    label?: string;\n    values?: Array<{ label: string; value: string }>;\n}\n\nexport interface BuilderInitOptions {\n    panelTitle?: string;\n    types?: string[];\n    getAvailableFields?: () => FieldMeta[];\n    getFieldValues?: (fieldName: string) => Array<{ label: string; value: string }> | null;\n    enableVisualEditor?: boolean;\n}\n\nconst DEFAULT_TYPES = [\n    'text', 'textarea', 'number', 'select', 'radio-group', 'checkbox-group',\n    'date', 'paragraph', 'header', 'file', 'autocomplete'\n];\n\n// -------------------------------------------------------------\n// Utility: safely read option values for a field from schema\n// Works even if inferFieldsFromBuilderJson() isn't present.\n// -------------------------------------------------------------\ntype FbChoice = { value?: string | number; label?: string; text?: string };\ntype FbField = { name?: string; label?: string; type?: string; values?: FbChoice[]; options?: FbChoice[] };\n\nfunction getFieldValuesSafe(forField: string): Array<{ value: string; label: string }> {\n    try {\n        // Prefer a project-provided helper if it exists, otherwise fallback to empty\n        const fields: FbField[] =\n            ((globalThis as any).inferFieldsFromBuilderJson?.() ?? []) as FbField[];\n\n        const f = fields.find(x => x?.name === forField);\n        const raw = (f?.values ?? f?.options ?? []) as FbChoice[];\n\n        return raw\n            .map((x: FbChoice) => {\n                const value =\n                    (typeof x?.value === 'number' ? String(x.value) : (x?.value as string)) ?? '';\n                const label = (x?.label ?? x?.text ?? value) as string;\n                return { value, label };\n            })\n            .filter(x => x.value !== '');\n    } catch {\n        return [];\n    }\n}\n\n\n\n/** Build the options object to pass into $('.build-wrap').formBuilder(...) */\nexport function withConditionalLogic(opts: BuilderInitOptions = {}) {\n    const panelTitle = opts.panelTitle || 'Conditional Logic';\n    const types = (opts.types && opts.types.length ? opts.types : DEFAULT_TYPES);\n    const enableVE = opts.enableVisualEditor !== false;\n\n    // 1) inject custom user attrs so formBuilder shows inputs in the field edit panel\n    const typeUserAttrs: Record<string, UserAttrs> = {};\n    types.forEach(t => {\n        typeUserAttrs[t] = {\n            logic: {\n                label: `${panelTitle} (JSON)`,\n                type: 'textarea',\n                value: '',\n                placeholder: '{ \"groups\":[...], \"actions\":[\"show\"] }'\n            },\n            logicApplyTo: {\n                label: `${panelTitle}: Apply To`,\n                type: 'select',\n                value: 'self',\n                options: {\n                    self: 'This Field',\n                    container: 'Field Container',\n                    group: 'Logic Group (below)'\n                }\n            },\n            logicGroup: {\n                label: `${panelTitle}: Group ID`,\n                type: 'text',\n                value: '',\n                placeholder: 'e.g., vehicleDetails'\n            }\n        };\n    });\n\n    function inferFieldsFromBuilderJson(): FieldMeta[] {\n        try {\n            const stage = (window as any).jQuery?.('.build-wrap');\n            const inst = stage?.data('formBuilder');\n            const json = inst?.actions?.getData?.('json');\n            const arr = typeof json === 'string' ? JSON.parse(json) : (Array.isArray(json) ? json : []);\n            return arr.filter((f: any) => f?.name).map((f: any) => ({\n                name: f.name,\n                type: f.type,\n                label: f.label,\n                values: Array.isArray(f.values)\n                    ? f.values.map((v: any) => ({ label: v.label ?? v.value, value: v.value }))\n                    : undefined\n            }));\n        } catch { return []; }\n    }\n\n    const getFields = (): FieldMeta[] => {\n        try {\n            const custom = opts.getAvailableFields?.();\n            if (custom && custom.length) return custom;\n        } catch { }\n        return inferFieldsFromBuilderJson();\n    };\n\n    const getValuesFor = (fieldName: string): Array<{ label: string; value: string }> | null => {\n        try {\n            const custom = opts.getFieldValues?.(fieldName);\n            if (custom) return custom;\n        } catch { }\n        const fm = getFields().find(f => f.name === fieldName);\n        return fm?.values ?? null;\n    };\n\n    /** Build the little visual-editor that writes JSON into the textarea */\n    function makeVE(\n        htmlParent: HTMLElement,\n        getTextArea: () => HTMLTextAreaElement,\n        getApplyTo: () => HTMLSelectElement,\n        getGroupId: () => HTMLInputElement\n    ) {\n        // container\n        const ve = document.createElement('div');\n        ve.className = 'fb-logic-ve';\n        ve.style.marginBottom = '8px';\n\n        // header\n        const hdr = document.createElement('div');\n        hdr.style.display = 'flex';\n        hdr.style.gap = '6px';\n        hdr.style.alignItems = 'center';\n        const title = document.createElement('strong');\n        title.textContent = 'Conditional Logic (Visual)';\n        const tip = document.createElement('span');\n        tip.style.fontSize = '12px';\n        tip.style.opacity = '0.7';\n        tip.textContent = 'â€” use this editor then save to JSON below';\n        hdr.appendChild(title);\n        hdr.appendChild(tip);\n        ve.appendChild(hdr);\n\n        // body\n        const veBody = document.createElement('div');\n        veBody.className = 'fb-logic-ve-body';\n        veBody.style.border = '1px dashed #cbd5e1';\n        veBody.style.padding = '8px';\n        veBody.style.marginTop = '6px';\n        ve.appendChild(veBody);\n\n        // mode\n        const modeWrap = document.createElement('div');\n        modeWrap.style.margin = '6px 0';\n        modeWrap.innerHTML = `\n    <label style=\"margin-right:8px;\">Mode</label>\n    <select class=\"ve-mode form-select form-select-sm\" style=\"display:inline-block; width:auto;\">\n      <option value=\"any\">ANY (OR)</option>\n      <option value=\"all\">ALL (AND)</option>\n    </select>\n  `;\n        veBody.appendChild(modeWrap);\n\n        // actions\n        const actionsWrap = document.createElement('div');\n        actionsWrap.style.margin = '6px 0';\n        actionsWrap.innerHTML = `\n    <label style=\"margin-right:8px;\">Actions</label>\n    <label class=\"form-check form-check-inline\"><input class=\"ve-act form-check-input\" type=\"checkbox\" value=\"show\" checked> <span class=\"form-check-label\">show</span></label>\n    <label class=\"form-check form-check-inline\"><input class=\"ve-act form-check-input\" type=\"checkbox\" value=\"require\"> <span class=\"form-check-label\">require</span></label>\n    <label class=\"form-check form-check-inline\"><input class=\"ve-act form-check-input\" type=\"checkbox\" value=\"enable\"> <span class=\"form-check-label\">enable</span></label>\n    <label class=\"form-check form-check-inline\"><input class=\"ve-act form-check-input\" type=\"checkbox\" value=\"disable\"> <span class=\"form-check-label\">disable</span></label>\n    <label class=\"form-check form-check-inline\"><input class=\"ve-act form-check-input\" type=\"checkbox\" value=\"hide\"> <span class=\"form-check-label\">hide</span></label>\n  `;\n        veBody.appendChild(actionsWrap);\n\n        // rules list\n        const rules = document.createElement('div');\n        rules.className = 've-rules';\n        rules.style.marginTop = '6px';\n        rules.style.display = 'grid';\n        rules.style.gap = '6px';\n        veBody.appendChild(rules);\n\n        // footer: Add rule + Save (moved here)\n        const footer = document.createElement('div');\n        footer.style.display = 'flex';\n        footer.style.justifyContent = 'flex-end';\n        footer.style.gap = '8px';\n        footer.style.marginTop = '8px';\n\n        const addBtn = document.createElement('button');\n        addBtn.type = 'button';\n        addBtn.className = 'btn btn-sm btn-outline-secondary';\n        addBtn.textContent = 'Add rule';\n\n        const save = document.createElement('button');\n        save.type = 'button';\n        save.className = 'btn btn-sm btn-primary';\n        save.textContent = 'Save to JSON';\n\n        footer.appendChild(addBtn);\n        footer.appendChild(save);\n        veBody.appendChild(footer);\n\n        // helpers that always read the latest fields/values\n        const getFieldsNow = (): Array<{ name: string; label?: string; type?: string; values?: { label: string; value: string }[] }> => {\n            try {\n                // Prefer provider the builder passed to withConditionalLogic()\n                const stage = (window as any).jQuery?.('.build-wrap');\n                const inst = stage?.data?.('formBuilder');\n                const data = inst?.actions?.getData?.('json');\n                const arr = typeof data === 'string' ? JSON.parse(data) : (Array.isArray(data) ? data : []);\n                return arr.filter((f: any) => f?.name).map((f: any) => ({\n                    name: f.name, type: f.type, label: f.label,\n                    values: Array.isArray(f.values) ? f.values.map((v: any) => ({ label: v.label ?? v.value, value: v.value })) : undefined\n                }));\n            } catch { return []; }\n        };\n\n        const getChoicesFor = (fieldName: string) => {\n            const fm = getFieldsNow().find(f => f.name === fieldName);\n            return fm?.values ?? null;\n        };\n\n        const buildFieldSelect = () => {\n            const sel = document.createElement('select');\n            sel.className = 've-field form-select form-select-sm';\n            sel.style.minWidth = '160px';\n            const fields = getFieldsNow();\n            if (!fields.length) {\n                const opt = document.createElement('option');\n                opt.value = '';\n                opt.textContent = '(no fields yet)';\n                sel.appendChild(opt);\n            } else {\n                fields.forEach(f => {\n                    const opt = document.createElement('option');\n                    opt.value = f.name;\n                    opt.textContent = f.label ? `${f.label} (${f.name})` : f.name;\n                    sel.appendChild(opt);\n                });\n            }\n            return sel;\n        };\n\n        const buildOpSelect = (forField: string) => {\n            const sel = document.createElement('select');\n            sel.className = 've-op form-select form-select-sm';\n            sel.style.minWidth = '140px';\n            const fm = getFieldsNow().find(f => f.name === forField);\n            const isNum = fm?.type === 'number';\n            const isChoice = fm?.type === 'radio-group' || fm?.type === 'select' || !!fm?.values?.length;\n            const ops = isNum\n                ? ['equals', 'notEquals', 'gt', 'gte', 'lt', 'lte', 'isEmpty', 'notEmpty']\n                : isChoice\n                    ? ['equals', 'notEquals', 'isEmpty', 'notEmpty']\n                    : ['equals', 'notEquals', 'contains', 'startsWith', 'endsWith', 'isEmpty', 'notEmpty'];\n            sel.innerHTML = '';\n            ops.forEach(o => {\n                const opt = document.createElement('option');\n                opt.value = o;\n                opt.textContent = o;\n                sel.appendChild(opt);\n            });\n            return sel;\n        };\n\n        const buildValueInput = (forField: string, current?: string) => {\n            const choices = getChoicesFor(forField);\n            if (choices && choices.length) {\n                const sel = document.createElement('select');\n                sel.className = 've-value form-select form-select-sm';\n                choices.forEach((v: { value: string; label: string }) => {\n                    const opt = document.createElement('option');\n                    opt.value = v.value;\n                    opt.textContent = v.label ?? v.value;\n                    sel.appendChild(opt);\n                });\n                if (current != null) sel.value = current;\n                return sel;\n            }\n            const input = document.createElement('input');\n            input.className = 've-value form-control form-control-sm';\n            input.type = 'text';\n            if (current != null) input.value = current;\n            return input;\n        };\n\n        function row(field?: string, op?: string, value?: string) {\n            const row = document.createElement('div');\n            row.className = 've-row';\n            row.style.display = 'flex';\n            row.style.gap = '6px';\n            row.style.alignItems = 'center';\n\n            const fSel = buildFieldSelect();\n            const initialField = field || (fSel.options[0]?.value || '');\n            const oSel = buildOpSelect(initialField);\n            const vWrap = document.createElement('div');\n\n            const renderValue = (fn: string, val?: string) => {\n                vWrap.innerHTML = '';\n                vWrap.appendChild(buildValueInput(fn, val));\n            };\n\n            // initialize row\n            if (field) fSel.value = field;\n            renderValue(fSel.value);\n            if (op) {\n                // rebuild ops based on chosen field\n                const newOps = buildOpSelect(fSel.value);\n                oSel.innerHTML = newOps.innerHTML;\n                oSel.value = op;\n            }\n            if (value != null) {\n                (vWrap.querySelector('.ve-value') as HTMLInputElement | HTMLSelectElement).value = value;\n            }\n\n            fSel.addEventListener('change', () => {\n                const newOps = buildOpSelect(fSel.value);\n                oSel.innerHTML = newOps.innerHTML;\n                renderValue(fSel.value);\n            });\n\n            row.appendChild(fSel);\n            row.appendChild(oSel);\n            row.appendChild(vWrap);\n\n            const rm = document.createElement('button');\n            rm.type = 'button';\n            rm.className = 'btn btn-sm btn-outline-danger';\n            rm.textContent = 'Remove';\n            rm.addEventListener('click', () => row.remove());\n            row.appendChild(rm);\n\n            rules.appendChild(row);\n        }\n\n        addBtn.addEventListener('click', () => row());\n\n        save.addEventListener('click', () => {\n            const _mode = (veBody.querySelector('.ve-mode') as HTMLSelectElement).value as 'any' | 'all';\n            const _actions = Array.from(veBody.querySelectorAll('.ve-act') as NodeListOf<HTMLInputElement>)\n                .filter(i => i.checked)\n                .map(i => i.value) as Array<'show' | 'hide' | 'enable' | 'disable' | 'require'>;\n\n            const ruleRows = Array.from(veBody.querySelectorAll('.ve-row'));\n            const rulesCfg = ruleRows.map(r => {\n                const f = (r.querySelector('.ve-field') as HTMLSelectElement).value;\n                const o = (r.querySelector('.ve-op') as HTMLSelectElement).value;\n                const valEl = (r.querySelector('.ve-value') as HTMLInputElement | HTMLSelectElement);\n                const v = (valEl as any).value ?? '';\n                return { field: f, op: o as any, value: v };\n            });\n\n            const cfg = { groups: [{ mode: _mode, rules: rulesCfg, actions: _actions }] };\n            const ta = (getTextArea() as any) as HTMLTextAreaElement | null;\n            if (ta) {\n                ta.value = JSON.stringify(cfg, null, 2);\n                alert('Conditional Logic JSON updated.');\n            } else {\n                alert('Could not find the logic JSON field to update.');\n            }\n        });\n\n        // Preload from JSON (null-safe)\n        try {\n            const ta = (getTextArea() as any) as HTMLTextAreaElement | null;\n            const raw = (ta && ta.value) || '';\n            if (raw && raw.trim()) {\n                const parsed = JSON.parse(raw);\n                const g = Array.isArray(parsed.groups) ? parsed.groups[0] : null;\n                if (g) {\n                    (veBody.querySelector('.ve-mode') as HTMLSelectElement).value = g.mode || 'any';\n                    const acts = new Set((g.actions || []) as string[]);\n                    veBody.querySelectorAll('.ve-act').forEach((i: any) => { i.checked = acts.has(i.value); });\n                    (g.rules || []).forEach((r: any) => row(r.field, r.op, r.value));\n                }\n            }\n        } catch { /* ignore */ }\n\n        htmlParent.prepend(ve);\n    }\n\n\n    function onOpenFieldEdit(editPanel: HTMLElement) {\n        const logicControls = Array.from(\n            editPanel.querySelectorAll('[name=\"logic\"], [name=\"logicApplyTo\"], [name=\"logicGroup\"]')\n        ) as HTMLElement[];\n        if (!logicControls.length) return;\n\n        let section = editPanel.querySelector('.fb-logic-section') as HTMLElement | null;\n        if (!section) {\n            section = document.createElement('div');\n            section.className = 'fb-logic-section';\n            section.innerHTML = `\n      <div class=\"fb-logic-header\" style=\"margin-top:8px; font-weight:600; cursor:pointer;\">\n        ${panelTitle}\n        <span style=\"font-weight:400; font-size:12px; opacity:.7\"> (toggle)</span>\n      </div>\n      <div class=\"fb-logic-body\" style=\"border:1px solid #e5e7eb; padding:8px; margin-top:6px; display:none;\"></div>\n    `;\n            editPanel.appendChild(section);\n            const header = section.querySelector('.fb-logic-header') as HTMLElement;\n            const body0 = section.querySelector('.fb-logic-body') as HTMLElement;\n            header.addEventListener('click', () => {\n                const open = body0.style.display !== 'none';\n                body0.style.display = open ? 'none' : '';\n            });\n        }\n\n        const body = section!.querySelector('.fb-logic-body') as HTMLElement;\n\n        // --- Advanced (JSON) panel FIRST ---\n        let adv = body.querySelector('.fb-logic-advanced') as HTMLElement | null;\n        if (!adv) {\n            adv = document.createElement('div');\n            adv.className = 'fb-logic-advanced';\n            adv.innerHTML = `\n      <div class=\"fb-logic-adv-header\" style=\"margin-top:10px; font-weight:600; cursor:pointer;\">\n        Advanced (JSON)\n        <span style=\"font-weight:400; font-size:12px; opacity:.7\"> (toggle)</span>\n      </div>\n      <div class=\"fb-logic-adv-body\" style=\"border:1px dashed #cbd5e1; padding:8px; margin-top:6px; display:none;\"></div>\n    `;\n            body.appendChild(adv);\n            const advHeader = adv.querySelector('.fb-logic-adv-header') as HTMLElement;\n            const advBody = adv.querySelector('.fb-logic-adv-body') as HTMLElement;\n            advHeader.addEventListener('click', () => {\n                const open = advBody.style.display !== 'none';\n                advBody.style.display = open ? 'none' : '';\n            });\n        }\n\n        // Move native controls inside Advanced body\n        const advBody = adv!.querySelector('.fb-logic-adv-body') as HTMLElement;\n        logicControls.forEach(el => {\n            const row = el.closest('.form-group') || el.closest('div') || el;\n            if (row && row.parentElement !== advBody) advBody.appendChild(row as HTMLElement);\n        });\n        // De-dup (defensive)\n        const seen = new Set<string>();\n        advBody.querySelectorAll<HTMLElement>('[name=\"logic\"], [name=\"logicApplyTo\"], [name=\"logicGroup\"]').forEach(ctrl => {\n            const n = ctrl.getAttribute('name')!;\n            if (seen.has(n)) {\n                const dupRow = ctrl.closest('.form-group') || ctrl.closest('div') || ctrl;\n                if (dupRow && dupRow.parentElement === advBody) (dupRow as HTMLElement).remove();\n            } else {\n                seen.add(n);\n            }\n        });\n\n        // --- Visual Editor AFTER controls exist ---\n        if (enableVE) {\n            const getTextArea = () => body.querySelector('[name=\"logic\"]') as HTMLTextAreaElement;\n            const getApplyTo = () => body.querySelector('[name=\"logicApplyTo\"]') as HTMLSelectElement;\n            const getGroupId = () => body.querySelector('[name=\"logicGroup\"]') as HTMLInputElement;\n\n            if (!body.querySelector('.fb-logic-ve')) {\n                const dupes = body.querySelectorAll('.fb-logic-ve');\n                if (dupes.length > 1) dupes.forEach((el, idx) => { if (idx > 0) el.remove(); });\n                makeVE(body, getTextArea, getApplyTo, getGroupId);\n            }\n        }\n    }\n\n\n    return { typeUserAttrs, onOpenFieldEdit };\n}\n\n/** Minimal Groups GUI living in a modal attached to a toolbar element */\nexport function attachLogicGroupsManager(\n    targetContainer: HTMLElement,\n    initialOrOpts?: string | {\n        initialJson?: string;\n        getAvailableFields?: () => FieldMeta[];\n        getFieldValues?: (fieldName: string) => Array<{ label: string; value: string }> | null;\n    }\n) {\n    const opts = (typeof initialOrOpts === 'string') ? { initialJson: initialOrOpts } : (initialOrOpts || {});\n    const state = { json: opts.initialJson || '' };\n\n    // ---- Helpers to obtain fields/values ----\n    function inferFieldsFromBuilderJson(): FieldMeta[] {\n        try {\n            const $stage = (window as any).jQuery?.('.build-wrap');\n            const fb = $stage?.data?.('formBuilder');\n            const data = fb?.actions?.getData?.('json');\n            const arr = typeof data === 'string' ? JSON.parse(data) : (Array.isArray(data) ? data : []);\n            return arr.filter((f: any) => f?.name).map((f: any) => ({\n                name: f.name, type: f.type, label: f.label,\n                values: Array.isArray(f.values) ? f.values.map((v: any) => ({ label: v.label ?? v.value, value: v.value })) : undefined\n            }));\n        } catch { return []; }\n    }\n    const getFields = (): FieldMeta[] => {\n        try { const x = opts.getAvailableFields?.(); if (x && x.length) return x; } catch { }\n        return inferFieldsFromBuilderJson();\n    };\n    const getValuesFor = (fieldName: string) => {\n        try { const x = opts.getFieldValues?.(fieldName); if (x) return x; } catch { }\n        const fm = getFields().find(f => f.name === fieldName);\n        return fm?.values ?? null;\n    };\n\n    // ---- UI scaffold: button + modal ----\n    const wrapper = document.createElement('div');\n    wrapper.style.margin = '8px 0';\n    wrapper.innerHTML = `\n    <button type=\"button\" class=\"btn btn-sm btn-outline-primary\">Logic Groups</button>\n    <div class=\"fb-logic-modal\" style=\"display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:99999;\">\n      <div style=\"background:#fff; max-width:900px; width:92%; margin:4% auto; padding:16px; border-radius:8px;\">\n        <div style=\"display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px;\">\n          <strong style=\"font-size:16px;\">Logic Groups</strong>\n          <div style=\"display:flex; gap:8px;\">\n            <button type=\"button\" class=\"btn btn-sm btn-secondary fb-groups-load-sample\">Load sample</button>\n            <button type=\"button\" class=\"btn btn-sm btn-outline-secondary fb-groups-from-json\">From JSON</button>\n            <button type=\"button\" class=\"btn btn-sm btn-primary fb-groups-save\">Save</button>\n            <button type=\"button\" class=\"btn btn-sm btn-light fb-logic-close\">Close</button>\n          </div>\n        </div>\n\n        <div class=\"fb-groups-ve-header\" style=\"font-weight:600;\">Visual Groups Editor\n          <span style=\"font-size:12px;opacity:.7;font-weight:400;\">(no JSON typing)</span>\n        </div>\n        <div class=\"fb-groups-ve-body\" style=\"border:1px dashed #cbd5e1; padding:8px; margin-top:6px;\">\n          <div class=\"fb-groups-list\"></div>\n          <button type=\"button\" class=\"btn btn-sm btn-outline-primary fb-groups-add\" style=\"margin-top:8px;\">Add group</button>\n        </div>\n\n        <div class=\"fb-groups-adv\" style=\"margin-top:10px;\">\n          <div class=\"fb-groups-adv-header\" style=\"font-weight:600; cursor:pointer;\">\n            Advanced (JSON)\n            <span style=\"font-size:12px;opacity:.7;font-weight:400;\">(toggle)</span>\n          </div>\n          <div class=\"fb-groups-adv-body\" style=\"border:1px dashed #cbd5e1; padding:8px; margin-top:6px; display:none;\">\n            <p style=\"font-size:12px; margin:0 0 6px 0; opacity:.75;\">Define reusable groups keyed by ID.</p>\n            <textarea class=\"fb-logic-json\" style=\"width:100%; height:240px; font-family:monospace;\"></textarea>\n          </div>\n        </div>\n      </div>\n    </div>\n  `;\n    targetContainer.prepend(wrapper);\n\n    const btn = wrapper.querySelector('button') as HTMLButtonElement;\n    const modal = wrapper.querySelector('.fb-logic-modal') as HTMLDivElement;\n    const closeBtn = modal.querySelector('.fb-logic-close') as HTMLButtonElement;\n    const loadBtn = modal.querySelector('.fb-groups-load-sample') as HTMLButtonElement;\n    const saveBtn = modal.querySelector('.fb-groups-save') as HTMLButtonElement;\n    const fromJson = modal.querySelector('.fb-groups-from-json') as HTMLButtonElement;\n    const advHdr = modal.querySelector('.fb-groups-adv-header') as HTMLDivElement;\n    const advBody = modal.querySelector('.fb-groups-adv-body') as HTMLDivElement;\n    const ta = modal.querySelector('.fb-logic-json') as HTMLTextAreaElement;\n    const listEl = modal.querySelector('.fb-groups-list') as HTMLDivElement;\n    const addGroupBtn = modal.querySelector('.fb-groups-add') as HTMLButtonElement;\n\n    const open = () => {\n        // Seed from window or current state\n        const srcObj = (window as any).fbLogicGroups && typeof (window as any).fbLogicGroups === 'object'\n            ? (window as any).fbLogicGroups\n            : (state.json ? safeParse(state.json) : {});\n        state.json = JSON.stringify(srcObj || {}, null, 2);\n        ta.value = state.json;\n        renderFromJson(srcObj || {});\n        modal.style.display = 'block';\n    };\n    const close = () => { modal.style.display = 'none'; };\n\n    btn.addEventListener('click', open);\n    closeBtn.addEventListener('click', close);\n    modal.addEventListener('click', (e) => { if (e.target === modal) close(); });\n\n    advHdr.addEventListener('click', () => {\n        const isOpen = advBody.style.display !== 'none';\n        advBody.style.display = isOpen ? 'none' : '';\n    });\n\n    loadBtn.addEventListener('click', () => {\n        const fields = getFields();\n        const first = fields[0]?.name || 'controller';\n        const obj = {\n            vehicleDetails: {\n                mode: 'any',\n                rules: [{ field: first, op: 'equals', value: 'yes' }],\n                actions: ['show', 'require']\n            }\n        };\n        ta.value = JSON.stringify(obj, null, 2);\n        renderFromJson(obj);\n    });\n\n    fromJson.addEventListener('click', () => {\n        const parsed = safeParse(ta.value) || {};\n        renderFromJson(parsed);\n    });\n\n    // ðŸ” SAVE: keep UI intact (no setData). Persist to window + patch export.\n    saveBtn.addEventListener('click', () => {\n        const obj = collectFromVe();\n        state.json = JSON.stringify(obj, null, 2);\n        ta.value = state.json;\n        (window as any).fbLogicGroups = obj;\n\n        // Patch export so JSON returned by getData('json') contains __logicGroups (no rebuild).\n        try {\n            const $stage = (window as any).jQuery?.('.build-wrap');\n            const fb = $stage?.data?.('formBuilder');\n            if (fb?.actions?.getData && !(fb as any).__fbLogicGroupsPatched) {\n                const origGetData = fb.actions.getData.bind(fb.actions);\n                (fb as any).__fbLogicGroupsPatched = true;\n\n                fb.actions.getData = (mode?: string) => {\n                    const out = origGetData(mode as any);\n                    if (mode !== 'json') return out;\n\n                    // always read the latest groups from window or state\n                    const groupsObj = (window as any).fbLogicGroups || (safeParse(state.json) || {});\n                    const groupsStr = JSON.stringify(groupsObj);\n\n                    try {\n                        const arr = typeof out === 'string' ? JSON.parse(out) : (Array.isArray(out) ? out : []);\n                        const idx = arr.findIndex((f: any) => f?.type === 'hidden' && (f?.name === '__logicGroups' || f?.name === 'logicGroups'));\n                        const fieldObj = { type: 'hidden', name: '__logicGroups', value: groupsStr, label: ' ', access: false, className: 'd-none' };\n                        if (idx >= 0) arr[idx] = { ...arr[idx], ...fieldObj };\n                        else arr.push(fieldObj);\n                        return JSON.stringify(arr);\n                    } catch {\n                        // if something goes off, just return original\n                        return out;\n                    }\n                };\n            }\n        } catch (e) {\n            console.warn('[logic-groups] export patch failed', e);\n        }\n\n        alert('Logic groups saved (no rebuild). They will be embedded into exported JSON automatically.');\n        close();\n    });\n\n    // âž• Add group now works reliably\n    addGroupBtn.addEventListener('click', () => addGroupBlock());\n\n    // ---- Helpers ----\n    function safeParse(txt: string): any | null { try { return JSON.parse(txt); } catch { return null; } }\n    function clearChildren(node: HTMLElement) { while (node.firstChild) node.removeChild(node.firstChild); }\n\n    function addGroupBlock(groupId: string = '') {\n        const groupWrap = document.createElement('div');\n        groupWrap.className = 'fb-group-block';\n        groupWrap.style.border = '1px solid #e5e7eb';\n        groupWrap.style.borderRadius = '6px';\n        groupWrap.style.padding = '8px';\n        groupWrap.style.marginTop = '8px';\n\n        // Header: Group ID\n        const header = document.createElement('div');\n        header.style.display = 'grid';\n        header.style.gridTemplateColumns = '1fr auto';\n        header.style.gap = '8px';\n        header.style.alignItems = 'center';\n\n        const idInput = document.createElement('input');\n        idInput.className = 'form-control form-control-sm fb-group-id';\n        idInput.placeholder = 'Group ID (e.g., vehicleDetails)';\n        idInput.value = groupId;\n\n        const delBtn = document.createElement('button');\n        delBtn.type = 'button';\n        delBtn.className = 'btn btn-sm btn-link text-danger';\n        delBtn.textContent = 'remove group';\n        delBtn.addEventListener('click', () => groupWrap.remove());\n\n        header.appendChild(idInput);\n        header.appendChild(delBtn);\n        groupWrap.appendChild(header);\n\n        // Inner body\n        const body = document.createElement('div');\n        body.style.border = '1px dashed #cbd5e1';\n        body.style.padding = '8px';\n        body.style.marginTop = '6px';\n        groupWrap.appendChild(body);\n\n        // Top row\n        const top = document.createElement('div');\n        top.style.display = 'flex';\n        top.style.flexWrap = 'wrap';\n        top.style.gap = '12px';\n        top.style.alignItems = 'center';\n        top.style.marginBottom = '6px';\n\n        const modeLbl = document.createElement('label');\n        modeLbl.textContent = 'Mode';\n        const modeSel = document.createElement('select');\n        modeSel.className = 'form-select form-select-sm fb-group-mode';\n        ['any', 'all'].forEach(v => {\n            const opt = document.createElement('option');\n            opt.value = v;\n            opt.textContent = v.toUpperCase() + (v === 'any' ? ' (OR)' : ' (AND)');\n            modeSel.appendChild(opt);\n        });\n\n        const actionsWrap = document.createElement('div');\n        actionsWrap.innerHTML = `\n      <label style=\"margin-right:8px;\">Actions</label>\n      <label class=\"form-check form-check-inline\"><input class=\"fb-act form-check-input\" type=\"checkbox\" value=\"show\" checked> <span class=\"form-check-label\">show</span></label>\n      <label class=\"form-check form-check-inline\"><input class=\"fb-act form-check-input\" type=\"checkbox\" value=\"require\"> <span class=\"form-check-label\">require</span></label>\n      <label class=\"form-check form-check-inline\"><input class=\"fb-act form-check-input\" type=\"checkbox\" value=\"enable\"> <span class=\"form-check-label\">enable</span></label>\n      <label class=\"form-check form-check-inline\"><input class=\"fb-act form-check-input\" type=\"checkbox\" value=\"disable\"> <span class=\"form-check-label\">disable</span></label>\n      <label class=\"form-check form-check-inline\"><input class=\"fb-act form-check-input\" type=\"checkbox\" value=\"hide\"> <span class=\"form-check-label\">hide</span></label>\n    `;\n\n        top.appendChild(modeLbl);\n        top.appendChild(modeSel);\n        top.appendChild(actionsWrap);\n        body.appendChild(top);\n\n        // Rules list + add button\n        const rulesList = document.createElement('div');\n        rulesList.className = 'fb-group-rules';\n        body.appendChild(rulesList);\n\n        const addRuleBtn = document.createElement('button');\n        addRuleBtn.type = 'button';\n        addRuleBtn.className = 'btn btn-sm btn-outline-secondary';\n        addRuleBtn.textContent = 'Add rule';\n        addRuleBtn.style.marginTop = '8px';\n        body.appendChild(addRuleBtn);\n\n        function addRuleRow(field?: string, op?: string, value?: string) {\n            const row = document.createElement('div');\n            row.className = 'fb-group-rule';\n            row.style.display = 'grid';\n            row.style.gridTemplateColumns = '1fr 1fr 1fr auto';\n            row.style.gap = '6px';\n            row.style.marginTop = '6px';\n\n            // field select\n            const fSel = document.createElement('select');\n            fSel.className = 'form-select form-select-sm fb-rule-field';\n            const fields = getFields();\n            if (!fields.length) {\n                const opt = document.createElement('option');\n                opt.value = '';\n                opt.textContent = '(no fields yet)';\n                fSel.appendChild(opt);\n            } else {\n                fields.forEach(f => {\n                    const opt = document.createElement('option');\n                    opt.value = f.name;\n                    opt.textContent = f.label ? `${f.label} (${f.name})` : f.name;\n                    fSel.appendChild(opt);\n                });\n            }\n            if (field) fSel.value = field;\n\n            // op select (dynamic by type)\n            const oSel = document.createElement('select');\n            oSel.className = 'form-select form-select-sm fb-rule-op';\n            const setOpsForField = (fn: string) => {\n                const fm = getFields().find(f => f.name === fn);\n                const isNum = fm?.type === 'number';\n                const isChoice = fm?.type === 'radio-group' || fm?.type === 'select' || !!fm?.values?.length;\n                const ops = isNum\n                    ? ['equals', 'notEquals', 'gt', 'gte', 'lt', 'lte', 'isEmpty', 'notEmpty']\n                    : isChoice\n                        ? ['equals', 'notEquals', 'isEmpty', 'notEmpty']\n                        : ['equals', 'notEquals', 'contains', 'startsWith', 'endsWith', 'isEmpty', 'notEmpty'];\n                oSel.innerHTML = '';\n                ops.forEach(o => {\n                    const opt = document.createElement('option');\n                    opt.value = o; opt.textContent = o;\n                    oSel.appendChild(opt);\n                });\n            };\n            setOpsForField(fSel.value);\n            if (op) oSel.value = op;\n\n            // value control\n            const vWrap = document.createElement('div');\n            vWrap.className = 'fb-rule-value-wrap';\n            const renderValueControl = (fn: string, current?: string) => {\n                vWrap.innerHTML = '';\n                const choices = getValuesFor(fn);\n                if (choices && choices.length) {\n                    const s = document.createElement('select');\n                    s.className = 'form-select form-select-sm fb-rule-value';\n                    choices.forEach(c => {\n                        const option = document.createElement('option');\n                        option.value = c.value;\n                        option.textContent = c.label ?? c.value;\n                        s.appendChild(option);\n                    });\n                    if (current) s.value = current;\n                    vWrap.appendChild(s);\n                } else {\n                    const i = document.createElement('input');\n                    i.type = 'text';\n                    i.className = 'form-control form-control-sm fb-rule-value';\n                    if (current) i.value = current;\n                    vWrap.appendChild(i);\n                }\n            };\n            renderValueControl(fSel.value, value);\n\n            // interactions\n            fSel.addEventListener('change', () => {\n                setOpsForField(fSel.value);\n                renderValueControl(fSel.value);\n            });\n\n            // remove rule\n            const rm = document.createElement('button');\n            rm.type = 'button';\n            rm.className = 'btn btn-sm btn-outline-danger';\n            rm.textContent = 'Remove';\n            rm.addEventListener('click', () => row.remove());\n\n            // mount\n            row.appendChild(fSel);\n            row.appendChild(oSel);\n            row.appendChild(vWrap);\n            row.appendChild(rm);\n            rulesList.appendChild(row);\n        }\n\n        addRuleBtn.addEventListener('click', () => addRuleRow());\n\n        // allow preset\n        (groupWrap as any)._set = (cfg: { mode?: string; actions?: string[]; rules?: any[] }) => {\n            if (cfg?.mode) (modeSel.value = cfg.mode);\n            const acts = new Set(cfg?.actions || []);\n            actionsWrap.querySelectorAll<HTMLInputElement>('.fb-act').forEach(i => { i.checked = acts.has(i.value); });\n            clearChildren(rulesList);\n            (cfg?.rules || []).forEach((r: any) => addRuleRow(r.field, r.op, r.value));\n        };\n\n        listEl.appendChild(groupWrap);\n        return groupWrap;\n    }\n\n    function renderFromJson(obj: Record<string, any>) {\n        clearChildren(listEl);\n        const keys = Object.keys(obj || {});\n        if (!keys.length) {\n            // UX: start with one blank group\n            addGroupBlock('');\n            return;\n        }\n        keys.forEach(id => {\n            const w = addGroupBlock(id);\n            (w as any)._set(obj[id] || {});\n        });\n    }\n\n    function collectFromVe(): Record<string, any> {\n        const result: Record<string, any> = {};\n        const blocks = listEl.querySelectorAll('.fb-group-block');\n        blocks.forEach((b: Element) => {\n            const id = (b.querySelector('.fb-group-id') as HTMLInputElement).value.trim();\n            if (!id) return;\n            const mode = (b.querySelector('.fb-group-mode') as HTMLSelectElement).value || 'any';\n            const actions = Array.from(b.querySelectorAll('.fb-act') as NodeListOf<HTMLInputElement>)\n                .filter(i => i.checked).map(i => i.value);\n            const rules: Array<{ field: string; op: string; value?: string }> = [];\n            const rows = b.querySelectorAll('.fb-group-rule');\n            rows.forEach((r: Element) => {\n                const field = (r.querySelector('.fb-rule-field') as HTMLSelectElement).value;\n                const op = (r.querySelector('.fb-rule-op') as HTMLSelectElement).value;\n                const vEl = (r.querySelector('.fb-rule-value') as HTMLInputElement | HTMLSelectElement);\n                const value = (vEl as any)?.value ?? '';\n                if (field && op) rules.push({ field, op, value });\n            });\n            result[id] = { mode, rules, actions };\n        });\n        return result;\n    }\n\n    return {\n        getJson: () => state.json,\n        setJson: (j: string) => { state.json = j; },\n        getGroups: () => safeParse(state.json || '{}') || {},\n    };\n}\n\n\n\n","import type { LogicConfig, LogicGroup, Rule, SetupOptions } from '../types';\n\ndeclare global {\n    interface Window {\n        fbLogicGroups?: Record<string, LogicGroup>;\n        __FB_LOGIC_DEBUG__?: boolean;\n        FB_GET_WRAPPER?: (el: HTMLElement) => HTMLElement;\n        _fbLogic?: { refresh: () => void }; // debug handle\n    }\n}\n\n/* ==============================\n   Utilities\n============================== */\n\nfunction cssEscape(name: string) {\n    const CSSObj: any = (window as any).CSS;\n    if (CSSObj && typeof CSSObj.escape === 'function') return CSSObj.escape(name);\n    return name.replace(/([^a-zA-Z0-9_-])/g, '\\\\$1');\n}\n\nfunction sourceSelector(fieldName: string) {\n    const n = cssEscape(fieldName);\n    return `[name=\"${n}\"], [name=\"${n}[]\"], [data-fb-name=\"${n}\"]`;\n}\n\nfunction defaultWrapper(el: HTMLElement): HTMLElement {\n    const candidates = ['.form-group', '.fb-field-wrapper', '.form-field', '.field-wrapper', '.row', '.mb-3', '.box'];\n    for (const c of candidates) {\n        const found = el.closest(c);\n        if (found) return found as HTMLElement;\n    }\n    return el.parentElement || el;\n}\n\nfunction getControlValue(el: HTMLElement): any {\n    if (el instanceof HTMLInputElement) {\n        if (el.type === 'radio') {\n            const name = el.name;\n            const group =\n                el.form?.querySelectorAll(`input[type=\"radio\"][name=\"${name}\"]`) ||\n                document.querySelectorAll(`input[type=\"radio\"][name=\"${name}\"]`);\n            for (const r of Array.from(group)) {\n                const rr = r as HTMLInputElement;\n                if (rr.checked) return rr.value;\n            }\n            return null;\n        }\n        if (el.type === 'checkbox') {\n            const name = el.name;\n            const group =\n                el.form?.querySelectorAll(`input[type=\"checkbox\"][name=\"${name}\"]`) ||\n                document.querySelectorAll(`input[type=\"checkbox\"][name=\"${name}\"]`);\n            const vals: string[] = [];\n            Array.from(group).forEach((cb) => {\n                const cbb = cb as HTMLInputElement;\n                if (cbb.checked) vals.push(cbb.value);\n            });\n            return vals;\n        }\n        return el.value;\n    }\n    if (el instanceof HTMLSelectElement) {\n        if (el.multiple) return Array.from(el.selectedOptions).map((o) => o.value);\n        return el.value;\n    }\n    if (el instanceof HTMLTextAreaElement) return el.value;\n    return (el as any).value ?? (el as any).textContent ?? null;\n}\n\nfunction testRule(value: any, rule: Rule): boolean {\n    const op = rule.op;\n    const expected = rule.value;\n\n    if (Array.isArray(value)) {\n        if (op === 'contains') return value.includes(expected);\n        if (op === 'equals') return value.includes(expected);\n        if (op === 'notEquals') return !value.includes(expected);\n        if (op === 'isEmpty') return value.length === 0;\n        if (op === 'notEmpty') return value.length > 0;\n        return false;\n    }\n\n    const valStr = value == null ? '' : String(value);\n    const expStr = expected == null ? '' : String(expected);\n    const valNum = Number(value);\n    const expNum = Number(expected);\n\n    switch (op) {\n        case 'equals': return value == expected;\n        case 'notEquals': return value != expected;\n        case 'contains': return valStr.includes(expStr);\n        case 'startsWith': return valStr.startsWith(expStr);\n        case 'endsWith': return valStr.endsWith(expStr);\n        case 'gt': return valNum > expNum;\n        case 'gte': return valNum >= expNum;\n        case 'lt': return valNum < expNum;\n        case 'lte': return valNum <= expNum;\n        case 'isEmpty': return valStr.trim() === '';\n        case 'notEmpty': return valStr.trim() !== '';\n        default: return false;\n    }\n}\n\nfunction evalGroup(form: HTMLElement, group: LogicGroup): boolean {\n    const results = group.rules.map((rule) => {\n        const src = form.querySelector(sourceSelector(rule.field)) as HTMLElement | null;\n        if (!src) return false;\n        const v = getControlValue(src);\n        return testRule(v, rule);\n    });\n    const ok = group.mode === 'all' ? results.every(Boolean) : results.some(Boolean);\n    if (window.__FB_LOGIC_DEBUG__) console.log('[fb-logic] group', group, 'results', results, 'ok?', ok);\n    return ok;\n}\n\nfunction setDisabled(el: HTMLElement, disabled: boolean) {\n    const inputs = el.querySelectorAll('input, select, textarea, button');\n    inputs.forEach((n: Element) => {\n        (n as HTMLInputElement).disabled = disabled;\n        if (disabled) (n as HTMLInputElement).required = false;\n    });\n}\n\nfunction setVisible(el: HTMLElement, visible: boolean) {\n    (el as HTMLElement).style.display = visible ? '' : 'none';\n    (el as HTMLElement).setAttribute('aria-hidden', visible ? 'false' : 'true');\n}\n\n/* ==============================\n   Actions + Targets\n============================== */\n\nfunction applyActions(target: HTMLElement, actions: LogicGroup['actions'], truthy: boolean) {\n    const shouldShow =\n        actions.includes('show') ? truthy :\n            actions.includes('hide') ? !truthy :\n                truthy;\n\n    setVisible(target, shouldShow);\n\n    if (actions.includes('disable')) setDisabled(target, true);\n    if (actions.includes('enable')) setDisabled(target, false);\n\n    if (actions.includes('require')) {\n        const inputs = target.querySelectorAll('input, select, textarea');\n        inputs.forEach((n: Element) => { (n as HTMLInputElement).required = shouldShow; });\n    }\n}\n\nfunction parseLogicAttr(el: HTMLElement): LogicConfig | null {\n    const raw = el.getAttribute('data-logic');\n    if (!raw) return null;\n    try { return JSON.parse(raw) as LogicConfig; }\n    catch {\n        if (window.__FB_LOGIC_DEBUG__) console.warn('Invalid data-logic JSON', raw, el);\n        return null;\n    }\n}\n\n/* ==============================\n   HYDRATION (Builder JSON â†’ DOM)\n============================== */\n\nfunction strifyLogic(logic: any): string | null {\n    if (!logic) return null;\n    if (typeof logic === 'string') return logic;\n    try { return JSON.stringify(logic); } catch { return null; }\n}\n\nfunction queryByNameAll(form: HTMLElement, name: string): NodeListOf<HTMLElement> {\n    const n = cssEscape(name);\n    return form.querySelectorAll<HTMLElement>(`[name=\"${n}\"], [name=\"${n}[]\"]`);\n}\n\nfunction hydrateFromFormData(form: HTMLElement, formData: any) {\n    if (!formData) return;\n    try { if (typeof formData === 'string') formData = JSON.parse(formData); } catch { return; }\n    if (!Array.isArray(formData)) return;\n\n    for (const field of formData) {\n        const name: string | undefined = field?.name;\n        if (!name) continue;\n\n        const nodes = queryByNameAll(form, name);\n        if (!nodes.length) continue;\n\n        const logicJson = strifyLogic(field.logic);\n        const applyTo: string = field.logicApplyTo || field.applyTo || 'self';\n        const groupId: string | undefined = field.logicGroup;\n\n        if (!logicJson && groupId && applyTo === 'group') {\n            nodes.forEach((el) => el.setAttribute('data-logic-group', String(groupId)));\n            continue;\n        }\n\n        if (!logicJson) continue;\n\n        if (applyTo === 'container') {\n            nodes.forEach((el) => {\n                const wrap =\n                    typeof window.FB_GET_WRAPPER === 'function'\n                        ? window.FB_GET_WRAPPER(el)\n                        : defaultWrapper(el);\n                wrap.setAttribute('data-logic-container', logicJson);\n            });\n        } else if (applyTo === 'group' && groupId) {\n            nodes.forEach((el) => el.setAttribute('data-logic-group', String(groupId)));\n        } else {\n            nodes.forEach((el) => el.setAttribute('data-logic', logicJson));\n        }\n    }\n}\n\nfunction normalizeActions(cfg: LogicConfig): LogicGroup['actions'] {\n    const a = (cfg.actions && cfg.actions.length ? cfg.actions : ['show']);\n    return a as LogicGroup['actions'];\n}\n\n/* ==============================\n   Target discovery + evaluation\n============================== */\n\nfunction findTargets(form: HTMLElement): Array<{\n    el: HTMLElement;\n    cfg: LogicConfig;\n    mode: 'self' | 'container' | 'group';\n    groupId?: string;\n}> {\n    const targets: Array<{\n        el: HTMLElement;\n        cfg: LogicConfig;\n        mode: 'self' | 'container' | 'group';\n        groupId?: string;\n    }> = [];\n\n    form.querySelectorAll('[data-logic]').forEach((el) => {\n        const cfg = parseLogicAttr(el as HTMLElement);\n        if (cfg) targets.push({ el: el as HTMLElement, cfg, mode: 'self' });\n    });\n\n    form.querySelectorAll('[data-logic-container]').forEach((el) => {\n        const raw = (el as HTMLElement).getAttribute('data-logic-container');\n        if (!raw) return;\n        try { targets.push({ el: el as HTMLElement, cfg: JSON.parse(raw) as LogicConfig, mode: 'container' }); }\n        catch { }\n    });\n\n    form.querySelectorAll('[data-logic-group]').forEach((el) => {\n        const id = (el as HTMLElement).getAttribute('data-logic-group') || '';\n        const group = window.fbLogicGroups?.[id];\n        if (group) {\n            const cfg: LogicConfig = { groups: [group], actions: group.actions, applyTo: 'group', logicGroup: id };\n            targets.push({ el: el as HTMLElement, cfg, mode: 'group', groupId: id });\n        }\n    });\n\n    if (window.__FB_LOGIC_DEBUG__) {\n        console.log('[fb-logic] targets found:', targets.length, targets);\n    }\n    return targets;\n}\n\nfunction reeval(form: HTMLElement, targets: ReturnType<typeof findTargets>, options: SetupOptions) {\n    const getWrapper = options.getWrapper || defaultWrapper;\n\n    targets.forEach((t) => {\n        const el = t.el;\n\n        let truthy = true;\n        if (t.cfg.groups && t.cfg.groups.length) truthy = t.cfg.groups.every((g) => evalGroup(form, g));\n\n        const wrapper =\n            t.mode === 'self' ? getWrapper(el) :\n                t.mode === 'container' ? el :\n                    getWrapper(el);\n\n        const actions = normalizeActions(t.cfg);\n        applyActions(wrapper, actions, truthy);\n\n        if (options.onState) options.onState(el, truthy);\n        if (window.__FB_LOGIC_DEBUG__) console.log('[fb-logic] applied', { el, mode: t.mode, actions, truthy, wrapper });\n    });\n}\n\n/* ==============================\n   Public API\n============================== */\n\nexport function setup(formEl: HTMLElement | Element, _formData?: any, options: SetupOptions = {}) {\n    const form = formEl as HTMLElement;\n\n    // --- 0) Extract Logic Groups from formData (hidden field) BEFORE target discovery\n    // We look for a hidden field named \"__logicGroups\" (or \"logicGroups\") and install it on window.\n    try {\n        if (_formData) {\n            const arr = Array.isArray(_formData)\n                ? _formData\n                : (typeof _formData === 'string' ? JSON.parse(_formData) : []);\n\n            if (Array.isArray(arr)) {\n                const grpField =\n                    arr.find((f: any) => f?.type === 'hidden' && (f?.name === '__logicGroups' || f?.name === 'logicGroups'));\n                if (grpField?.value && typeof grpField.value === 'string') {\n                    try {\n                        const parsed = JSON.parse(grpField.value);\n                        if (parsed && typeof parsed === 'object') (window as any).fbLogicGroups = parsed;\n                    } catch { /* ignore bad JSON */ }\n                }\n            }\n        }\n    } catch { /* non-fatal */ }\n\n    // --- 1) Hydrate per-field attributes (data-logic, data-logic-container, data-logic-group)\n    if (_formData) {\n        try { hydrateFromFormData(form, _formData); }\n        catch (e) { if (window.__FB_LOGIC_DEBUG__) console.warn('hydrateFromFormData failed', e); }\n    }\n\n    // --- 2) Discover targets and bind listeners\n    const targets = findTargets(form);\n\n    const watched = new Set<string>();\n    // collect all fields referenced by rules (including group rules)\n    targets.forEach((t) => {\n        const groups = (t.cfg?.groups || []) as any[];\n        groups.forEach((g) => {\n            (g.rules || []).forEach((r: any) => {\n                if (r?.field) {\n                    watched.add(r.field);\n                    // also watch array-notation variants, e.g. \"foo[]\" vs \"foo\"\n                    watched.add(String(r.field).replace(/\\[\\]$/, ''));\n                }\n            });\n        });\n    });\n\n    if (window.__FB_LOGIC_DEBUG__) console.log('[fb-logic] watching fields:', Array.from(watched));\n\n    const handler = (ev: Event) => {\n        const t = ev.target as HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement | null;\n        if (!t) return;\n        const nameAttr = t.name || (t.getAttribute && t.getAttribute('name')) || '';\n        if (!nameAttr) return;\n        const simple = nameAttr.replace(/\\[\\]$/, '');\n        if (watched.has(nameAttr) || watched.has(simple)) {\n            if (window.__FB_LOGIC_DEBUG__) console.log('[fb-logic] change on', nameAttr, 'â†’ reeval');\n            reeval(form, targets, options);\n        }\n    };\n\n    form.addEventListener('input', handler, true);\n    form.addEventListener('change', handler, true);\n\n    // First run\n    reeval(form, targets, options);\n\n    // Optional external refresh hook\n    form.addEventListener('fb:reinit-logic' as any, () => reeval(form, targets, options));\n\n    // expose for quick debugging from console\n    (window as any)._fbLogic = { refresh: () => reeval(form, targets, options) };\n}\n\n\nexport function refresh(formEl: HTMLElement | Element) {\n    setup(formEl);\n}\n\nexport function evaluateField(formEl: HTMLElement | Element, _name: string) {\n    setup(formEl);\n}\n"],"names":["DEFAULT_TYPES","withConditionalLogic","opts","panelTitle","types","enableVE","typeUserAttrs","t","makeVE","htmlParent","getTextArea","getApplyTo","getGroupId","ve","hdr","title","tip","veBody","modeWrap","actionsWrap","rules","footer","addBtn","save","getFieldsNow","_a","_b","_c","_d","stage","inst","data","f","v","getChoicesFor","fieldName","fm","buildFieldSelect","sel","fields","opt","buildOpSelect","forField","isNum","isChoice","ops","o","buildValueInput","current","choices","input","row","field","op","value","fSel","initialField","oSel","vWrap","renderValue","fn","val","newOps","rm","_mode","_actions","i","rulesCfg","r","cfg","ta","raw","parsed","g","acts","onOpenFieldEdit","editPanel","logicControls","section","header","body0","open","body","adv","advHeader","advBody","el","seen","ctrl","n","dupRow","dupes","idx","attachLogicGroupsManager","targetContainer","initialOrOpts","state","inferFieldsFromBuilderJson","$stage","fb","getFields","x","getValuesFor","wrapper","btn","modal","closeBtn","loadBtn","saveBtn","fromJson","advHdr","listEl","addGroupBtn","srcObj","safeParse","renderFromJson","close","e","isOpen","obj","collectFromVe","origGetData","mode","out","groupsObj","groupsStr","arr","fieldObj","addGroupBlock","txt","clearChildren","node","groupId","groupWrap","idInput","delBtn","top","modeLbl","modeSel","rulesList","addRuleBtn","addRuleRow","setOpsForField","renderValueControl","s","c","option","keys","id","result","b","actions","vEl","j","cssEscape","name","CSSObj","sourceSelector","defaultWrapper","candidates","found","getControlValue","group","rr","vals","cb","cbb","testRule","rule","expected","valStr","expStr","valNum","expNum","evalGroup","form","results","src","ok","setDisabled","disabled","setVisible","visible","applyActions","target","truthy","shouldShow","parseLogicAttr","strifyLogic","logic","queryByNameAll","hydrateFromFormData","formData","nodes","logicJson","applyTo","normalizeActions","findTargets","targets","reeval","options","getWrapper","setup","formEl","_formData","grpField","watched","handler","ev","nameAttr","simple","refresh","evaluateField","_name"],"mappings":"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"}